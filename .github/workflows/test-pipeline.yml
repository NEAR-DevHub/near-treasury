name: Test Pipeline

on:
  workflow_dispatch:
    inputs:
      browser:
        description: "Browser to test"
        required: false
        default: "chromium"
        type: choice
        options:
          - chromium
          - firefox
          - webkit
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: test-pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  install:
    name: Install Dependencies
    uses: ./.github/workflows/install-dependencies.yml
    with:
      node-version: "20"

  build-application:
    name: Build Application
    needs: install
    uses: ./.github/workflows/build-application.yml
    with:
      node-version: "20"
    secrets: inherit

  playwright_components:
    name: Components Tests
    needs: [install]
    uses: ./.github/workflows/playwright_components.yml
    with:
      node-version: "20"
      browser: ${{ github.event.inputs.browser || 'chromium' }}
    secrets: inherit

  playwright_dashboard:
    name: Dashboard Tests
    needs: [install, build-application]
    uses: ./.github/workflows/playwright_dashboard.yml
    with:
      node-version: "20"
      browser: ${{ github.event.inputs.browser || 'chromium' }}
    secrets: inherit

  playwright_settings:
    name: Settings Tests
    needs: [install, build-application]
    uses: ./.github/workflows/playwright_settings.yml
    with:
      node-version: "20"
      browser: ${{ github.event.inputs.browser || 'chromium' }}
    secrets: inherit

  playwright_payments:
    name: Payments Tests
    needs: [install, build-application]
    uses: ./.github/workflows/playwright_payments.yml
    with:
      node-version: "20"
      browser: ${{ github.event.inputs.browser || 'chromium' }}
    secrets: inherit

  playwright_intents:
    name: Intents Tests
    needs: [install]
    uses: ./.github/workflows/playwright_intents.yml
    with:
      node-version: "20"
      browser: ${{ github.event.inputs.browser || 'chromium' }}
    secrets: inherit

  playwright_stake_delegation:
    name: Stake Delegation Tests
    needs: [install, build-application]
    uses: ./.github/workflows/playwright_stake_delegation.yml
    with:
      node-version: "20"
      browser: ${{ github.event.inputs.browser || 'chromium' }}
    secrets: inherit

  playwright_sandbox:
    name: Sandbox Tests
    needs: [install, build-application]
    uses: ./.github/workflows/playwright_sandbox.yml
    with:
      node-version: "20"
      browser: ${{ github.event.inputs.browser || 'chromium' }}
    secrets: inherit

  summary:
    name: Test Summary
    needs:
      - playwright_components
      - playwright_dashboard
      - playwright_settings
      - playwright_payments
      - playwright_intents
      - playwright_stake_delegation
      - playwright_sandbox
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## Test Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All test suites completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Components | ${{ needs.playwright_components.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dashboard | ${{ needs.playwright_dashboard.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Settings | ${{ needs.playwright_settings.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Payments | ${{ needs.playwright_payments.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Intents | ${{ needs.playwright_intents.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Stake Delegation | ${{ needs.playwright_stake_delegation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sandbox | ${{ needs.playwright_sandbox.result }} |" >> $GITHUB_STEP_SUMMARY
